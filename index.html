<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drape Area Calculator</title>
    <!-- Use the v2 assets for this build -->
    <link rel="stylesheet" href="style (2).css" />
    <script src="utils (2).js"></script>
    <script src="script (2).js"></script>
    <!-- Load OpenCV.js from CDN -->
    <script async src="https://docs.opencv.org/3.4.0/opencv.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <h1><i class="fas fa-ruler-combined"></i> Drape Area Calculator</h1>
        <p class="subtitle">
          Measure fabric drape area with automatic coin detection
        </p>
      </header>

      <!-- Setup Instructions -->
      <div class="card instructions">
        <h2><i class="fas fa-info-circle"></i> How to Use</h2>
        <ol>
          <li><strong>Step 1:</strong> Upload image or use camera</li>
          <li>
            <strong>Step 2:</strong> Click precisely on the coin in the image
          </li>
          <li>
            <strong>Step 3:</strong> System auto-detects coin and sets scale
          </li>
          <li>
            <strong>Step 4:</strong> Auto-process for drape area and coefficient
          </li>
        </ol>
        <p class="tip">
          <i class="fas fa-lightbulb"></i> Tip: Ensure coin is clearly visible
          for best detection
        </p>
      </div>

      <!-- Image Source Selection -->
      <div class="card">
        <h3><i class="fas fa-image"></i> Get Image</h3>
        <div class="controls">
          <button id="startCamera" class="btn btn-primary">
            <i class="fas fa-camera"></i> Use Camera
          </button>
          <div class="file-upload-wrapper">
            <button id="uploadImage" class="btn btn-info">
              <i class="fas fa-upload"></i> Upload Image
            </button>
            <input
              type="file"
              id="imageUpload"
              accept="image/*"
              style="display: none"
            />
          </div>
          <button id="reset" class="btn btn-secondary" disabled>
            <i class="fas fa-redo"></i> Reset
          </button>
        </div>
      </div>

      <!-- Image Display -->
      <div class="card">
        <h3><i class="fas fa-search"></i> Image & Coin Selection</h3>
        <div class="image-display-container">
          <video id="video" autoplay playsinline style="display: none"></video>
          <div class="image-wrapper">
            <canvas id="mainCanvas"></canvas>
            <!-- Circular Guide for Framing -->
            <div id="circularGuide" class="circular-guide" style="display: none;"></div>
            <!-- Level Indicator -->
            <div id="levelIndicator" class="level-indicator" style="display: none;">
              <div class="level-bubble">
                <div class="level-center"></div>
                <div class="level-dot"></div>
              </div>
              <div class="level-label">Level</div>
            </div>
            <div class="zoom-controls">
              <button id="zoomIn" class="zoom-btn" title="Zoom In">
                <i class="fas fa-search-plus"></i>
              </button>
              <button id="zoomOut" class="zoom-btn" title="Zoom Out">
                <i class="fas fa-search-minus"></i>
              </button>
              <button id="resetZoom" class="zoom-btn" title="Reset Zoom">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
          </div>
          <p class="click-instruction">
            <i class="fas fa-mouse-pointer"></i> Click exactly on the coin in
            the image above
          </p>
        </div>

        <div class="capture-controls">
          <button id="capture" class="btn btn-success" disabled>
            <i class="fas fa-camera-retro"></i> Capture Image
          </button>
        </div>
      </div>

      <!-- Reference Selection -->
      <div class="card">
        <h3><i class="fas fa-bullseye"></i> Reference & Shape</h3>
        <div class="reference-instructions">
          <p><strong>After clicking on coin:</strong></p>
          <p>1. Coin will be auto-detected and circled in red</p>
          <p>2. Scale will be automatically calculated</p>
          <p>3. Drape area will be auto-processed</p>
        </div>

        <div class="reference-selection">
          <div class="form-group">
            <label for="refType">Coin Type:</label>
            <select id="refType" class="form-control">
              <option value="coin">Indian 1 Rupee Coin (2.5cm)</option>
              <option value="coin2">Indian 2 Rupee Coin (2.7cm)</option>
              <option value="coin5">Indian 5 Rupee Coin (2.5cm)</option>
              <option value="custom">Custom Size</option>
            </select>
          </div>

          <div id="customRef" style="display: none">
            <div class="form-group">
              <label for="refDiameter">Diameter (cm):</label>
              <input
                type="number"
                id="refDiameter"
                class="form-control"
                step="0.01"
                min="0.1"
                value="2.5"
              />
            </div>
          </div>

          <div class="reference-display">
            <div class="reference-info">
              <p>
                <strong>Coin Detection:</strong>
                <span id="detectionStatus">Not detected</span>
              </p>
              <p>
                <strong>Pixel Diameter:</strong>
                <span id="pixelDistance">--</span> px
              </p>
              <p>
                <strong>Scale:</strong> <span id="scaleFactor">--</span> px/cm
              </p>
            </div>
            <button
              id="clearReference"
              class="btn btn-small btn-danger"
              disabled
            >
              <i class="fas fa-trash"></i> Clear Reference
            </button>
          </div>
        </div>

        <!-- Optional shape comparator -->
        <div class="shape-section">
          <h4><i class="fas fa-vector-square"></i> Shape Area (Length × Width)</h4>
          <p class="shape-help">
            Enter the physical dimensions of a rectangular shape to compare with the
            detected drape area.
          </p>
          <div class="form-row">
            <div class="form-group">
              <label for="shapeLength">Length (cm):</label>
              <input
                type="number"
                id="shapeLength"
                class="form-control"
                step="0.1"
                min="0"
                placeholder="e.g. 10"
              />
            </div>
            <div class="form-group">
              <label for="shapeWidth">Width (cm):</label>
              <input
                type="number"
                id="shapeWidth"
                class="form-control"
                step="0.1"
                min="0"
                placeholder="e.g. 5"
              />
            </div>
          </div>
          <div class="result-item shape-result-inline">
            <span class="label">Shape Area (cm²):</span>
            <span id="shapeAreaValue" class="value">--</span>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="card">
        <h2><i class="fas fa-chart-bar"></i> Results</h2>
        <div id="results" class="results-container">
          <div class="result-item">
            <span class="label">Drape Area (cm²):</span>
            <span id="actualArea" class="value">--</span>
          </div>
          <div class="result-item">
            <span class="label">Drape Area (px²):</span>
            <span id="pixelAreaValue" class="value">--</span>
          </div>
          <div class="result-item">
            <span class="label">Drape Coefficient:</span>
            <span id="drapeCoefficient" class="value">--</span>
          </div>
          <div class="result-item">
            <span class="label">Fabric Property:</span>
            <span id="fabricProperty" class="value">--</span>
          </div>
          <div class="result-item">
            <span class="label">Status:</span>
            <span id="status" class="value">Ready to start</span>
          </div>
        </div>

        <!-- Visual Output -->
        <div class="image-comparison">
          <div class="image-box">
            <h4>Original with Coin</h4>
            <canvas id="outputCanvas"></canvas>
          </div>
          <div class="image-box">
            <h4>Drape Area Detected</h4>
            <canvas id="processedCanvas"></canvas>
          </div>
        </div>
      </div>

      <!-- Drape Tester Settings -->
      <div class="card">
        <h3><i class="fas fa-cogs"></i> Drape Tester Settings</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="diskDiameter">Support Disk Diameter (cm):</label>
            <input
              type="number"
              id="diskDiameter"
              class="form-control"
              value="18.0"
              step="0.1"
            />
          </div>
          <div class="form-group">
            <label for="fabricDiameter">Fabric Diameter (cm):</label>
            <input
              type="number"
              id="fabricDiameter"
              class="form-control"
              value="30.0"
              step="0.1"
            />
          </div>
        </div>
        <div class="form-group">
          <label for="autoCalculate">Auto Calculate:</label>
          <div class="checkbox-group">
            <input type="checkbox" id="autoCalculate" checked />
            <label for="autoCalculate"
              >Automatically calculate drape after coin detection</label
            >
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="card">
        <h3><i class="fas fa-history"></i> Measurement History</h3>
        <table id="historyTable">
          <thead>
            <tr>
              <th>Time</th>
              <th>Area (cm²)</th>
              <th>Drape %</th>
              <th>Property</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <!-- Will be populated by JS -->
          </tbody>
        </table>
        <div class="history-controls">
          <button id="exportData" class="btn btn-outline">
            <i class="fas fa-download"></i> Export CSV
          </button>
          <button id="saveImage" class="btn btn-outline" disabled>
            <i class="fas fa-save"></i> Save Result
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
