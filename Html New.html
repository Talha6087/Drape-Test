<script>
const canvas = new fabric.Canvas('canvas', {
    preserveObjectStacking: true,
    selection: false
});

let coinCircle, drapeCircle;

document.getElementById('upload').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = function (event) {
        fabric.Image.fromURL(
            event.target.result,
            function (img) {

                canvas.clear();

                const maxWidth = 800;
                const scale = Math.min(maxWidth / img.width, 1);

                img.set({
                    scaleX: scale,
                    scaleY: scale,
                    left: 0,
                    top: 0,
                    selectable: false,
                    evented: false,
                    crossOrigin: 'anonymous'
                });

                canvas.setWidth(img.getScaledWidth());
                canvas.setHeight(img.getScaledHeight());

                canvas.add(img);
                canvas.sendToBack(img);

                addOverlays();
                canvas.renderAll();
            },
            { crossOrigin: 'anonymous' }
        );
    };

    reader.readAsDataURL(file);
});

function addOverlays() {
    coinCircle = new fabric.Circle({
        radius: 30,
        left: 40,
        top: 40,
        fill: 'transparent',
        stroke: '#fbbf24',
        strokeWidth: 4,
        hasControls: true
    });

    drapeCircle = new fabric.Circle({
        radius: 80,
        left: 150,
        top: 150,
        fill: 'rgba(59,130,246,0.3)',
        stroke: '#2563eb',
        strokeWidth: 3,
        hasControls: true
    });

    canvas.add(coinCircle);
    canvas.add(drapeCircle);
    canvas.setActiveObject(drapeCircle);
}
</script>
